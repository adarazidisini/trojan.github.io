<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Pengaduan Banjir Balangan</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        * {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #60a5fa 100%);
        }
        
        .card-shadow {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .map-container {
            height: 500px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-verified {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .status-resolved {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .flood-marker {
            background-color: #ef4444;
            border: 3px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #10b981;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full overflow-auto" style="background: linear-gradient(to bottom, #eff6ff, #ffffff);"><!-- Header -->
   <header class="gradient-bg text-white py-8 px-4">
    <div class="max-w-7xl mx-auto">
     <div class="flex items-center gap-4 mb-4">
      <div class="bg-white p-3 rounded-xl">
       <svg class="w-10 h-10 text-blue-600" fill="currentColor" viewbox="0 0 24 24"><path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5zm0 18c-3.53 0-6.43-2.61-6.92-6h13.84c-.49 3.39-3.39 6-6.92 6zm7-8H5c0-2.76 2.24-5 5-5h4c2.76 0 5 2.24 5 5z" />
       </svg>
      </div>
      <div>
       <h1 id="header-title" class="text-4xl font-bold">Sistem Informasi Banjir Balangan</h1>
       <p id="header-subtitle" class="text-blue-100 text-lg">Kabupaten Balangan, Kalimantan Selatan</p>
      </div>
     </div>
     <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4 flex items-center gap-3">
      <div class="bg-red-500 rounded-full p-2 pulse-animation">
       <svg class="w-6 h-6 text-white" fill="currentColor" viewbox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
       </svg>
      </div>
      <div>
       <p class="font-semibold">Pemantauan Realtime</p>
       <p class="text-sm text-blue-100" id="report-count">0 Laporan Banjir Aktif</p>
      </div>
     </div>
    </div>
   </header>
   <div class="max-w-7xl mx-auto px-4 py-8"><!-- Peta Interaktif -->
    <div class="bg-white rounded-2xl p-6 card-shadow mb-8">
     <div class="flex items-center justify-between mb-4">
      <h2 class="text-2xl font-bold text-gray-800">üó∫Ô∏è Peta Sebaran Titik Banjir</h2>
      <div class="flex gap-4 text-sm">
       <div class="flex items-center gap-2">
        <div class="w-4 h-4 bg-red-500 rounded-full"></div><span class="text-gray-600">Banjir Aktif</span>
       </div>
      </div>
     </div>
     <div id="map" class="map-container"></div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><!-- Form Pengaduan -->
     <div class="bg-white rounded-2xl p-6 card-shadow">
      <h2 id="form-title" class="text-2xl font-bold text-gray-800 mb-6">üìù Laporkan Kejadian Banjir</h2>
      <form id="flood-form" class="space-y-4">
       <div><label class="block text-sm font-semibold text-gray-700 mb-2" for="nama">Nama Pelapor *</label> <input type="text" id="nama" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors" placeholder="Masukkan nama lengkap">
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2" for="kontak">Nomor Kontak *</label> <input type="tel" id="kontak" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors" placeholder="08xx-xxxx-xxxx">
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2" for="kecamatan">Kecamatan *</label> <select id="kecamatan" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"> <option value="">Pilih Kecamatan</option> <option value="Awayan">Awayan</option> <option value="Batu Mandi">Batu Mandi</option> <option value="Halong">Halong</option> <option value="Juai">Juai</option> <option value="Lampihong">Lampihong</option> <option value="Paringin">Paringin</option> <option value="Paringin Selatan">Paringin Selatan</option> <option value="Tebing Tinggi">Tebing Tinggi</option> </select>
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2" for="lokasi">Lokasi Detail *</label> <input type="text" id="lokasi" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors" placeholder="Jalan, desa, atau landmark">
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2" for="tinggi">Perkiraan Tinggi Air *</label> <select id="tinggi" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"> <option value="">Pilih Ketinggian</option> <option value="< 30 cm">Rendah (&lt; 30 cm)</option> <option value="30-70 cm">Sedang (30-70 cm)</option> <option value="> 70 cm">Tinggi (&gt; 70 cm)</option> </select>
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2" for="deskripsi">Deskripsi Kejadian</label> <textarea id="deskripsi" rows="3" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors" placeholder="Jelaskan kondisi banjir, dampak, dll"></textarea>
       </div><button type="submit" id="submit-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg transition-colors shadow-lg hover:shadow-xl"> Kirim Laporan </button>
      </form>
     </div><!-- Daftar Laporan -->
     <div class="bg-white rounded-2xl p-6 card-shadow">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">üìä Laporan Terkini</h2>
      <div id="reports-list" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
       <div class="text-center text-gray-400 py-8">
        <svg class="w-16 h-16 mx-auto mb-3 text-gray-300" fill="currentColor" viewbox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z" />
        </svg>
        <p>Belum ada laporan banjir</p>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
        const defaultConfig = {
            judul_website: "Sistem Informasi Banjir Balangan",
            subjudul: "Kabupaten Balangan, Kalimantan Selatan",
            judul_form: "üìù Laporkan Kejadian Banjir",
            pesan_sukses: "Laporan berhasil dikirim! Terima kasih atas partisipasi Anda.",
            background_color: "#eff6ff",
            primary_color: "#2563eb",
            surface_color: "#ffffff",
            text_color: "#1f2937",
            accent_color: "#ef4444",
            font_family: "Plus Jakarta Sans",
            font_size: 16
        };

        let map;
        let markers = [];
        let allReports = [];
        
        const kecamatanCoords = {
            "Awayan": [-2.3, 115.5],
            "Batu Mandi": [-2.2, 115.6],
            "Halong": [-2.15, 115.55],
            "Juai": [-2.25, 115.45],
            "Lampihong": [-2.4, 115.4],
            "Paringin": [-2.35, 115.5],
            "Paringin Selatan": [-2.4, 115.5],
            "Tebing Tinggi": [-2.2, 115.5]
        };

        function initMap() {
            map = L.map('map').setView([-2.3, 115.5], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);
        }

        function addMarkerToMap(report) {
            const lat = report.lat || kecamatanCoords[report.kecamatan][0];
            const lng = report.lng || kecamatanCoords[report.kecamatan][1];
            
            const offsetLat = lat + (Math.random() - 0.5) * 0.02;
            const offsetLng = lng + (Math.random() - 0.5) * 0.02;
            
            const marker = L.circleMarker([offsetLat, offsetLng], {
                radius: 10,
                fillColor: '#ef4444',
                color: '#ffffff',
                weight: 3,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);
            
            marker.bindPopup(`
                <div class="p-2">
                    <h3 class="font-bold text-base mb-1">${report.lokasi}</h3>
                    <p class="text-sm text-gray-600 mb-1"><strong>Kecamatan:</strong> ${report.kecamatan}</p>
                    <p class="text-sm text-gray-600 mb-1"><strong>Tinggi Air:</strong> ${report.tinggi_air}</p>
                    <p class="text-sm text-gray-600"><strong>Pelapor:</strong> ${report.nama_pelapor}</p>
                </div>
            `);
            
            markers.push(marker);
        }

        function clearMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
        }

        function renderReports(reports) {
            allReports = reports;
            const reportsList = document.getElementById('reports-list');
            const reportCount = document.getElementById('report-count');
            
            reportCount.textContent = `${reports.length} Laporan Banjir Aktif`;
            
            clearMarkers();
            
            if (reports.length === 0) {
                reportsList.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <svg class="w-16 h-16 mx-auto mb-3 text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z"/>
                        </svg>
                        <p>Belum ada laporan banjir</p>
                    </div>
                `;
                return;
            }
            
            const sortedReports = [...reports].sort((a, b) => {
                return new Date(b.waktu_lapor) - new Date(a.waktu_lapor);
            });
            
            reportsList.innerHTML = sortedReports.map(report => {
                const waktu = new Date(report.waktu_lapor);
                const waktuStr = waktu.toLocaleString('id-ID', { 
                    day: 'numeric', 
                    month: 'short', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                addMarkerToMap(report);
                
                return `
                    <div class="border-2 border-gray-100 rounded-xl p-4 hover:border-blue-300 transition-colors">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg text-gray-800">${report.lokasi}</h3>
                                <p class="text-sm text-gray-500">${report.kecamatan}</p>
                            </div>
                            <span class="status-badge status-pending">Aktif</span>
                        </div>
                        <div class="space-y-1 text-sm text-gray-600 mb-3">
                            <p>üíß <strong>Tinggi Air:</strong> ${report.tinggi_air}</p>
                            <p>üë§ <strong>Pelapor:</strong> ${report.nama_pelapor}</p>
                            <p>üìû <strong>Kontak:</strong> ${report.kontak}</p>
                            ${report.deskripsi ? `<p>üìù ${report.deskripsi}</p>` : ''}
                        </div>
                        <div class="flex items-center gap-2 text-xs text-gray-400">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                            </svg>
                            ${waktuStr}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        const dataHandler = {
            onDataChanged(data) {
                renderReports(data);
            }
        };

        async function onConfigChange(config) {
            const baseFont = config.font_family || defaultConfig.font_family;
            const baseFontStack = 'system-ui, -apple-system, sans-serif';
            const fontSize = config.font_size || defaultConfig.font_size;
            
            document.getElementById('header-title').textContent = config.judul_website || defaultConfig.judul_website;
            document.getElementById('header-title').style.fontFamily = `${baseFont}, ${baseFontStack}`;
            document.getElementById('header-title').style.fontSize = `${fontSize * 2}px`;
            
            document.getElementById('header-subtitle').textContent = config.subjudul || defaultConfig.subjudul;
            document.getElementById('header-subtitle').style.fontFamily = `${baseFont}, ${baseFontStack}`;
            document.getElementById('header-subtitle').style.fontSize = `${fontSize * 1.125}px`;
            
            document.getElementById('form-title').textContent = config.judul_form || defaultConfig.judul_form;
            document.getElementById('form-title').style.fontFamily = `${baseFont}, ${baseFontStack}`;
            document.getElementById('form-title').style.fontSize = `${fontSize * 1.5}px`;
            
            document.getElementById('app').style.background = `linear-gradient(to bottom, ${config.background_color || defaultConfig.background_color}, #ffffff)`;
            
            const headerEl = document.querySelector('header');
            headerEl.style.background = `linear-gradient(135deg, ${config.primary_color || defaultConfig.primary_color} 0%, #3b82f6 50%, #60a5fa 100%)`;
            
            const cards = document.querySelectorAll('.bg-white');
            cards.forEach(card => {
                card.style.backgroundColor = config.surface_color || defaultConfig.surface_color;
            });
            
            const textElements = document.querySelectorAll('.text-gray-800');
            textElements.forEach(el => {
                el.style.color = config.text_color || defaultConfig.text_color;
            });
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.style.backgroundColor = config.primary_color || defaultConfig.primary_color;
            submitBtn.style.fontFamily = `${baseFont}, ${baseFontStack}`;
            submitBtn.style.fontSize = `${fontSize}px`;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            initMap();
            
            const initResult = await window.dataSdk.init(dataHandler);
            if (!initResult.isOk) {
                console.error("Failed to initialize data SDK");
                return;
            }

            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    onConfigChange,
                    mapToCapabilities: (config) => ({
                        recolorables: [
                            {
                                get: () => config.background_color || defaultConfig.background_color,
                                set: (value) => {
                                    window.elementSdk.config.background_color = value;
                                    window.elementSdk.setConfig({ background_color: value });
                                }
                            },
                            {
                                get: () => config.surface_color || defaultConfig.surface_color,
                                set: (value) => {
                                    window.elementSdk.config.surface_color = value;
                                    window.elementSdk.setConfig({ surface_color: value });
                                }
                            },
                            {
                                get: () => config.text_color || defaultConfig.text_color,
                                set: (value) => {
                                    window.elementSdk.config.text_color = value;
                                    window.elementSdk.setConfig({ text_color: value });
                                }
                            },
                            {
                                get: () => config.primary_color || defaultConfig.primary_color,
                                set: (value) => {
                                    window.elementSdk.config.primary_color = value;
                                    window.elementSdk.setConfig({ primary_color: value });
                                }
                            },
                            {
                                get: () => config.accent_color || defaultConfig.accent_color,
                                set: (value) => {
                                    window.elementSdk.config.accent_color = value;
                                    window.elementSdk.setConfig({ accent_color: value });
                                }
                            }
                        ],
                        borderables: [],
                        fontEditable: {
                            get: () => config.font_family || defaultConfig.font_family,
                            set: (value) => {
                                window.elementSdk.config.font_family = value;
                                window.elementSdk.setConfig({ font_family: value });
                            }
                        },
                        fontSizeable: {
                            get: () => config.font_size || defaultConfig.font_size,
                            set: (value) => {
                                window.elementSdk.config.font_size = value;
                                window.elementSdk.setConfig({ font_size: value });
                            }
                        }
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["judul_website", config.judul_website || defaultConfig.judul_website],
                        ["subjudul", config.subjudul || defaultConfig.subjudul],
                        ["judul_form", config.judul_form || defaultConfig.judul_form],
                        ["pesan_sukses", config.pesan_sukses || defaultConfig.pesan_sukses]
                    ])
                });
            }
            
            const form = document.getElementById('flood-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitBtn = document.getElementById('submit-btn');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="loading-spinner"></div> Mengirim...';
                
                const kecamatan = document.getElementById('kecamatan').value;
                const coords = kecamatanCoords[kecamatan];
                
                const reportData = {
                    nama_pelapor: document.getElementById('nama').value,
                    kontak: document.getElementById('kontak').value,
                    kecamatan: kecamatan,
                    lokasi: document.getElementById('lokasi').value,
                    tinggi_air: document.getElementById('tinggi').value,
                    deskripsi: document.getElementById('deskripsi').value,
                    lat: coords[0],
                    lng: coords[1],
                    waktu_lapor: new Date().toISOString(),
                    status: "pending"
                };
                
                if (allReports.length >= 999) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    showToast("Batas maksimal 999 laporan tercapai. Mohon hubungi administrator.");
                    return;
                }
                
                const result = await window.dataSdk.create(reportData);
                
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                if (result.isOk) {
                    const config = window.elementSdk?.config || defaultConfig;
                    showToast(config.pesan_sukses || defaultConfig.pesan_sukses);
                    form.reset();
                } else {
                    showToast("Terjadi kesalahan saat mengirim laporan. Silakan coba lagi.");
                }
            });
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ba8a821422ff8d0',t:'MTc2Nzg0MzQ1MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>